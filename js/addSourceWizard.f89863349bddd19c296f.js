"use strict";(self.webpackChunksources=self.webpackChunksources||[]).push([[3791],{29061:(e,t,a)=>{a.r(t),a.d(t,{AddSourceButton:()=>ne,default:()=>ce});var s=a(28416),i=a.n(s),r=a(45697),o=a.n(r),n=a(41609),c=a.n(n),u=a(44012),l=a(11454),p=a(86706),d=a(86896),m=a(67850),y=a(46985),h=a(73047),g=a(22955),f=a(18111),S=a(12567),T=a(31379),v=a(96354),b=a(99473),E=a(48880),w=a(64124);const C=e=>{const t=(0,d.Z)(),a=(0,E.default)(),{authentication:s}=a.getState().values,r=e.validate&&e.validate.filter((({type:e})=>e!==w.Z.REQUIRED)),o={...e,...s&&s.id?{isRequired:!1,helperText:t.formatMessage({id:"wizard.changeAuthHelper",defaultMessage:"Changing this resets your current {label}."},{label:e.label}),validate:r}:{}},n=b.ZP[v.Z.TEXT_FIELD];return i().createElement(n,{...o})};var M=a(85017),_=a(26946),R=a(49288);const Z={schema:{},sourceTypes:[],isLoading:!0},B=e=>i().createElement(m.ZP,{...e,showFormControls:!1}),z=({sourceTypes:e,applicationTypes:t,disableAppSelection:a,isCancelling:r,onCancel:o,values:n,onSubmit:c,selectedType:u,initialWizardState:l,activeCategory:m})=>{const v=(0,R.useFlag)("sources.wizard.lighthouse"),[{schema:b,sourceTypes:E,applicationTypes:w,isLoading:z},q]=(0,s.useReducer)(((e,{type:t,sourceTypes:a,applicationTypes:s,container:i,disableAppSelection:r,intl:o,selectedType:n,initialWizardState:c,activeCategory:u,hcsEnrolled:l})=>{if("loaded"===t)return{...e,schema:(0,h.ZP)(a.filter(T.Z).filter((0,T.j)(u)),s.filter(S.Z).filter((0,S.W)(a,u)),r,i,o,n,c,u,v,l),isLoading:!1,sourceTypes:a,applicationTypes:s,hcsEnrolled:l}}),Z),A=(0,p.v9)((({sources:e})=>e.hcsEnrolled),p.wU),k=(0,s.useRef)(!1),O=(0,s.useRef)(document.createElement("div")),x=(0,d.Z)();return(0,s.useEffect)((()=>{k.current=!0;const s=[];return e||s.push((0,g.lH)()),t||s.push((0,g.$l)()),Promise.all(s).then((s=>{const i=s.find((e=>Object.prototype.hasOwnProperty.call(e,"sourceTypes"))),r=s.find((e=>Object.prototype.hasOwnProperty.call(e,"applicationTypes")));k.current&&q({type:"loaded",sourceTypes:e||i.sourceTypes,applicationTypes:t||r.applicationTypes,hcsEnrolled:A,disableAppSelection:a,container:O.current,intl:x,selectedType:u,initialWizardState:l,activeCategory:m})})),()=>{k.current=!1}}),[]),(0,s.useEffect)((()=>{O.current.style.opacity=r?0:1}),[r]),z?i().createElement(y.e,{className:"sources",isOpen:!0,onClose:o,title:(0,f.Z5)(m),description:(0,f.A6)(m),steps:[{name:"Loading",component:i().createElement(_.Z,{onClose:()=>o()}),isFinishedStep:!0}]}):i().createElement(M.Z,{initialValues:{...n,...u&&{source_type:u}},schema:b,onSubmit:(e,t,a)=>c(e,E,a,w,A),onCancel:o,FormTemplate:B,subscription:{values:!0},componentMapper:{authentication:C}})};z.propTypes={onCancel:o().func.isRequired,onSubmit:o().func.isRequired,sourceTypes:o().arrayOf(o().shape({id:o().string.isRequired,name:o().string.isRequired,product_name:o().string.isRequired,schema:o().shape({authentication:o().array,endpoint:o().object})})),applicationTypes:o().arrayOf(o().shape({id:o().string.isRequired,name:o().string.isRequired,display_name:o().string.isRequired})),values:o().object,disableAppSelection:o().bool,isCancelling:o().bool,selectedType:o().string,initialWizardState:o().object,activeCategory:o().string},z.defaultProps={values:{},disableAppSelection:!1};const q=z;var A=a(21925),k=a(64129),O=a(90573),x=a(16872),F=a(55140),j=a(32952),N=a(96380);const W=({id:e})=>{const t=(0,d.Z)().formatMessage({id:"wizard.editSource",defaultMessage:"Edit source"}),{getApp:a,isBeta:s}=(0,F.Z)();return"sources"===a()?i().createElement(N.Z,{to:`/detail/${e}`},i().createElement(l.Button,{variant:"primary",className:"pf-u-mt-xl"},t)):i().createElement(l.Button,{variant:"primary",className:"pf-u-mt-xl",component:"a",target:"_blank",href:`${(0,j.Z)(s())}/detail/${e}`,rel:"noopener noreferrer"},t)};W.propTypes={id:o().string.isRequired};const P=W;var D=a(29494),L=a(93759),V=a(27552),$=a(54243),I=a(85779),U=a(75614);const H=({afterSubmit:e,afterError:t,isFinished:a,isErrored:r,successfulMessage:o,hideSourcesButton:n,returnButtonTitle:c,reset:p,createdSource:m={},tryAgain:h,afterSuccess:g,sourceTypes:S,activeCategory:T})=>{const[v,b]=(0,s.useState)(),[E,w]=(0,s.useState)(),C=m.applications?.some((e=>e?.extra?.storage_only)),M=m.applications?.some((e=>e?.application_type_id===U.sC)),R=m.applications?.some((e=>e?.extra?.hcs)),Z=(0,d.Z)(),B=()=>(b(!0),(0,O.Rj)().deleteSource(m.id).then((()=>{g&&g(),w(!0)})).catch((()=>b(!1)))),z=i().createElement(l.Button,{variant:"link",onClick:p},Z.formatMessage({id:"wizard.addAnotherSource",defaultMessage:"Add another source"}));let q;if(E)q=i().createElement(L.Z,{onClose:e,title:Z.formatMessage({id:"wizard.removeSourceSuccessTitle",defaultMessage:"Removing successful"}),successfulMessage:Z.formatMessage({id:"wizard.removeSourceSuccessDescription",defaultMessage:"Source was successfully removed."}),hideSourcesButton:n,returnButtonTitle:c,secondaryActions:z});else if(v)q=i().createElement(_.Z,{customText:Z.formatMessage({id:"wizard.removingSource",defaultMessage:"Removing source"})});else if(a)switch((0,x.Z)(m)){case"unavailable":q=i().createElement(V.Z,{onClose:e,secondaryActions:i().createElement(l.Button,{variant:"link",onClick:B},Z.formatMessage({id:"wizard.removeSource",defaultMessage:"Remove source"})),Component:()=>i().createElement(P,{id:m.id}),message:(0,D.Z)(m,Z),title:Z.formatMessage({id:"wizard.configurationUnsuccessful",defaultMessage:"Configuration unsuccessful"})});break;case"timeout":q=i().createElement($.Z,{onClose:e,returnButtonTitle:c,secondaryActions:z,...M&&C&&{uuid:m?.uid}});break;default:q=m.source_type_id===S.find((({name:e})=>"amazon"===e))?.id?i().createElement(I.Z,{onClose:e}):i().createElement(L.Z,{onClose:e,successfulMessage:M&&C?`You have chosen to manually customize the cost data set sent to ${R?U.X0:"Cost Management"}, you will still need to perform additional steps to complete the process.`:o,...M&&C&&{title:i().createElement(u.Z,{id:"wizard.waitTheresMore",defaultMessage:"Success, but wait there's more!"}),uuid:m?.uid},hideSourcesButton:n,returnButtonTitle:c,secondaryActions:z})}else q=r?i().createElement(V.Z,{onClose:t,primaryAction:h,secondaryActions:i().createElement(k.Text,{component:"a",target:"_blank",href:"https://access.redhat.com/support/cases/#/case/new/open-case?caseCreate=true",rel:"noopener noreferrer"},Z.formatMessage({id:"wizard.openTicket",defaultMessage:"Open a support case"})),returnButtonTitle:Z.formatMessage({id:"wizard.retryText",defaultMessage:"Retry"})}):i().createElement(_.Z,{customText:Z.formatMessage({id:"wizard.loadingText",defaultMessage:"Validating credentials"}),description:i().createElement(k.TextContent,null,i().createElement(k.Text,{className:"pf-u-mb-md"},Z.formatMessage({id:"wizard.loadingDescription-a",defaultMessage:"This might take some time. You'll receive a notification if you are still in the Sources application when the process completes. Otherwise, you can check the status in the main sources table at any time."})),i().createElement(k.Text,null,Z.formatMessage({id:"wizard.loadingDescription-b",defaultMessage:"In the meantime, you can close this window while the validation process continues."}))),onClose:t,cancelTitle:Z.formatMessage({id:"wizard.close",defaultMessage:"Close"})});const F=i().useMemo((()=>document.querySelector(".pf-v5-c-page.chr-c-page")),[]);return i().createElement(A.Modal,{isOpen:!0,width:"58%",hasNoBodyWrapper:!0,appendTo:F,showClose:!1},i().createElement(y.e,{className:"sources",onClose:a?e:t,title:(0,f.Z5)(T),description:(0,f.A6)(T),steps:[{name:"Finish",component:q,isFinishedStep:!0}]}))};H.propTypes={afterSubmit:o().func.isRequired,afterError:o().func.isRequired,isFinished:o().bool.isRequired,isErrored:o().bool.isRequired,successfulMessage:o().node.isRequired,hideSourcesButton:o().bool,returnButtonTitle:o().node.isRequired,errorMessage:o().node,reset:o().func,createdSource:o().object,tryAgain:o().func,afterSuccess:o().func,sourceTypes:o().arrayOf(o().shape({id:o().string.isRequired,name:o().string.isRequired})),activeCategory:o().string};const Y=H;var X=a(70642),G=a(5454),J=a(5495);const Q=async e=>{try{const t=new Date,a=await(0,O.Rj)().bulkCreate({sources:[{...e.source,source_type_name:e.source_type}],authentications:[{...e.authentication,resource_name:e.source.name,resource_type:"source"}],applications:e.applications.map((t=>({application_type_id:t,source_name:e.source.name})))}),s=await(0,G.h)(a.authentications[0].id,void 0,void 0,"showAuthentication",t);return{...a,...a.sources[0],authentications:[s]}}catch(e){throw await(0,J.Z)(e)}};var K=a(85490),ee=a(33646);const te=e=>e.url?(e=>{if(!e)return{};try{const t=new URL(e);return{scheme:t.protocol.replace(/:$/,""),host:t.hostname,port:t.port,path:t.pathname}}catch(e){return console.log(e),{}}})(e.url):e,ae=async(e,t=[],a)=>{let s;try{const i={sources:[{...e.source,source_type_name:e.source_type}],endpoints:[],authentications:[],applications:[]},r=e.url||e.endpoint;if(r){const{scheme:t,host:a,port:s,path:r}=te(e),o=parseInt(s,10);i.endpoints.push({...e.endpoint,default:!0,source_name:e.source.name,scheme:t,host:a,port:isNaN(o)?void 0:o,path:r})}const o=e.application?.application_type_id&&e.application?.application_type_id!==f.Dt;o&&i.applications.push({...e.application,source_name:e.source.name}),e.authentication&&e.authentication.authtype!==ee.Z.type&&i.authentications.push({...e.authentication,resource_type:r?"endpoint":o?"application":"source",resource_name:e.source.name,...o&&{resource_name:a?.find((({id:t})=>t===e.application.application_type_id))?.name},...r&&{resource_name:te(e).host}});const n=await(0,O.Rj)().bulkCreate(i);s=n.sources?.[0];let c=n.applications?.[0],u=n.endpoints?.[0],l=n.authentications?.[0];if(r&&o&&await(0,O.Rj)().createAuthApp({application_id:c.id,authentication_id:l.id}),await(0,K.Z)(s.id),c){const e=t.includes(c.application_type_id)?1e4:0;c=await(0,G.h)(c.id,e)}return u&&(u=await(0,G.h)(u.id,void 0,void 0,"getEndpoint")),{...s,endpoint:[u].filter(Boolean),applications:[c].filter(Boolean)}}catch(e){throw await(0,J.S)(e,s?s.id:void 0)}};var se=a(95772);const ie=(e,t)=>({isSubmitted:!1,isFinished:!1,isErrored:!1,isCancelling:!1,values:e,createdSource:{},error:void 0,activeCategory:t}),re=(e,{type:t,values:a,data:s,error:i,initialValues:r,sourceTypes:o,applicationTypes:n})=>{switch(t){case"reset":return ie(r,e.activeCategory);case"prepareSubmitState":return{...e,isFinished:!1,isErrored:!1,error:void 0,isSubmitted:!0,values:a,sourceTypes:o,applicationTypes:n};case"setSubmitted":return{...e,isFinished:!0,createdSource:s};case"setErrored":return{...e,isErrored:!0,error:i.toString()};case"onStay":return{...e,isCancelling:!1};case"showCancelModal":return{...e,isCancelling:!0,values:a}}},oe=({successfulMessage:e,isOpen:t,sourceTypes:a,applicationTypes:r,disableAppSelection:o,hideSourcesButton:n,returnButtonTitle:u,initialValues:l,onClose:p,afterSuccess:d,selectedType:m,initialWizardState:y,submitCallback:h,activeCategory:g})=>{const[{isErrored:f,isFinished:S,isSubmitted:T,values:v,error:b,isCancelling:E,createdSource:w,activeCategory:C,...M},_]=(0,s.useReducer)(re,ie(l,g)),R=(e,t,a,s,i)=>(_({type:"prepareSubmitState",values:e,sourceTypes:t,applicationTypes:s}),((0,X.Z)(e.source)?Q:ae)({...e,application:{...e.application,extra:{...e.application?.extra||{},hcs:!!i}}},(0,U.T2)(s),s).then((e=>{d&&d(e),h&&h({isSubmitted:!0,createdSource:e,sourceTypes:t}),_({type:"setSubmitted",data:e})})).catch((s=>{h&&h({isErrored:!0,error:s,values:e,sourceTypes:t,wizardState:a}),_({type:"setErrored",error:s})}))),Z=()=>_({type:"reset",initialValues:l});return t?T?i().createElement(Y,{afterSubmit:()=>{p(void 0,w),Z()},afterError:()=>p({}),isFinished:S,isErrored:f,successfulMessage:e,hideSourcesButton:n,returnButtonTitle:u,errorMessage:b,reset:Z,createdSource:w,tryAgain:()=>R(v,M.sourceTypes,void 0,M.applicationTypes),afterSuccess:d,sourceTypes:M.sourceTypes,activeCategory:C}):i().createElement(i().Fragment,null,E&&i().createElement(se.Z,{onExit:()=>p(v),onStay:()=>_({type:"onStay"})}),i().createElement(q,{isCancelling:E,values:v,onSubmit:R,onCancel:e=>c()(e)?p({}):_({type:"showCancelModal",values:e}),sourceTypes:a,applicationTypes:r,disableAppSelection:o,selectedType:m,initialWizardState:y,activeCategory:C})):null};oe.propTypes={afterSuccess:o().func,sourceTypes:o().arrayOf(o().shape({id:o().string.isRequired,name:o().string.isRequired,product_name:o().string.isRequired,schema:o().shape({authentication:o().array,endpoint:o().object})})),applicationTypes:o().arrayOf(o().shape({id:o().string.isRequired,name:o().string.isRequired,display_name:o().string.isRequired})),onClose:o().func.isRequired,isOpen:o().bool.isRequired,successfulMessage:o().node,initialValues:o().shape({[o().string]:o().oneOf([o().string,o().array,o().number,o().bool])}),disableAppSelection:o().bool,hideSourcesButton:o().bool,returnButtonTitle:o().node,selectedType:o().string,initialWizardState:o().object,submitCallback:o().func,activeCategory:o().oneOf([U.B0,U.JL])},oe.defaultProps={successfulMessage:i().createElement(u.Z,{id:"wizard.successfulMessage",defaultMessage:"Your source was successfully added."}),initialValues:{},returnButtonTitle:i().createElement(u.Z,{id:"wizard.goBackToSources",defaultMessage:"Go back to Sources"})};const ne=e=>{const[t,a]=(0,s.useState)(!1);return i().createElement(i().Fragment,null,i().createElement(l.Button,{variant:"primary",onClick:()=>a(!0)},(0,f.Z5)()),i().createElement(oe,{isOpen:t,onClose:()=>a(!1),...e}))},ce=oe},31379:(e,t,a)=>{a.d(t,{Z:()=>o,j:()=>r});var s=a(75614);const i=[s.OH,s.N9],r=(e,t)=>({category:a,name:s})=>t?a===e:a===e&&!i.includes(s),o=e=>e.schema},70642:(e,t,a)=>{a.d(t,{Z:()=>i});var s=a(64072);const i=e=>e?.app_creation_workflow===s.b}}]);
//# sourceMappingURL=../sourcemaps/addSourceWizard.93bde139aa76bab6802dde5c3b547404.js.map